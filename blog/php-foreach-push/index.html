<!DOCTYPE HTML>

<html>
    <head>
        <script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "\/"
        },
        "articleSection" : "blog",
        "name" : "关于循环fread后push数组，造成内存异常大并越界问题的思考",
        "headline" : "关于循环fread后push数组，造成内存异常大并越界问题的思考",
        "description" : "原问题：\nphp版本5.3.6，线程安全版本，debian平台，php的memory_limit是16M event.txt文件只要有行就行，每行最好长一点，比较好重现，比如： 11111111111111111111111111111111111111111111 22222222222222222222222222222222222222222222 脚本：\n$fp = fopen(\x26quot;event.txt\x26quot;, \x26quot;r\x26quot;); if(!$fp)exit(1); $arr = array(); while(true){ $line = null; $event = null; flush(); gc_collect_cycles(); var_dump(number_format(memory_get_usage(true))); $line = fgets($fp, 4096 * 1024); var_dump(number_format(memory_get_usage())); array_push($arr, $line); if(feof($fp))rewind($fp); } 通过后台命令行执行这个，会发现，memory_get_usage(true)会隔一段时间上升4M左右（没算，目测可能正好就是4M），而memory_get_usage()一直不大，一会就Allowed memory size of 16777216 bytes exhausted了 最终显示： 。。。。 。。。。 。。。。 string(10) \x26ldquo;13,893,632\x26rdquo; string(9) \x26ldquo;1,968,844\x26rdquo; string(10) \x26ldquo;13,893,632\x26rdquo; string(9) \x26ldquo;1,968,988\x26rdquo; string(10) \x26ldquo;13,893,632\x26rdquo; string(9) \x26ldquo;1,969,132\x26rdquo; string(10) \x26ldquo;13,893,632\x26rdquo; string(9) \x26ldquo;1,969,276\x26rdquo; string(10) \x26ldquo;13,893,632\x26rdquo; string(9) \x26ldquo;1,969,364\x26rdquo; string(10) \x26ldquo;13,893,632\x26rdquo; string(9) \x26ldquo;1,969,436\x26rdquo; string(10) \x26ldquo;13,893,632\x26rdquo; string(9) \x26ldquo;1,969,580\x26rdquo; string(10) \x26ldquo;13,893,632\x26rdquo; string(9) \x26ldquo;1,969,724\x26rdquo; string(10) \x26ldquo;13,893,632\x26rdquo; Fatal error: Allowed memory size of 16777216 bytes exhausted (tried to allocate 4194305 bytes) in \/home\/eChance\/eChance\/net_manager.",
        "inLanguage" : "en",
        "author" : "",
        "creator" : "",
        "publisher": "",
        "accountablePerson" : "",
        "copyrightHolder" : "",
        "copyrightYear" : "2013",
        "datePublished": "2013-02-01 20:58:36 \x2b0800 \x2b0800",
        "dateModified" : "2013-02-01 20:58:36 \x2b0800 \x2b0800",
        "url" : "\/blog\/php-foreach-push\/",
        "wordCount" : "159",
        "keywords" : [ "Blog" ]
    }
    </script>
        
            
                <title>关于循环fread后push数组，造成内存异常大并越界问题的思考</title>
            
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.60.1" />
        


        
        
            
                <meta name="description" content="HTML5 UP theme, Future Imperfect with some extra goodies, ported by Julio Pescador. Powered by Hugo">
            
        

        <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="关于循环fread后push数组，造成内存异常大并越界问题的思考"/>
<meta name="twitter:description" content="原问题：
php版本5.3.6，线程安全版本，debian平台，php的memory_limit是16M event.txt文件只要有行就行，每行最好长一点，比较好重现，比如： 11111111111111111111111111111111111111111111 22222222222222222222222222222222222222222222 脚本：
$fp = fopen(&quot;event.txt&quot;, &quot;r&quot;); if(!$fp)exit(1); $arr = array(); while(true){ $line = null; $event = null; flush(); gc_collect_cycles(); var_dump(number_format(memory_get_usage(true))); $line = fgets($fp, 4096 * 1024); var_dump(number_format(memory_get_usage())); array_push($arr, $line); if(feof($fp))rewind($fp); } 通过后台命令行执行这个，会发现，memory_get_usage(true)会隔一段时间上升4M左右（没算，目测可能正好就是4M），而memory_get_usage()一直不大，一会就Allowed memory size of 16777216 bytes exhausted了 最终显示： 。。。。 。。。。 。。。。 string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,968,844&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,968,988&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,969,132&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,969,276&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,969,364&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,969,436&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,969,580&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,969,724&rdquo; string(10) &ldquo;13,893,632&rdquo; Fatal error: Allowed memory size of 16777216 bytes exhausted (tried to allocate 4194305 bytes) in /home/eChance/eChance/net_manager."/>
<meta name="twitter:site" content="@example"/>

        <meta property="og:title" content="关于循环fread后push数组，造成内存异常大并越界问题的思考" />
<meta property="og:description" content="原问题：
php版本5.3.6，线程安全版本，debian平台，php的memory_limit是16M event.txt文件只要有行就行，每行最好长一点，比较好重现，比如： 11111111111111111111111111111111111111111111 22222222222222222222222222222222222222222222 脚本：
$fp = fopen(&quot;event.txt&quot;, &quot;r&quot;); if(!$fp)exit(1); $arr = array(); while(true){ $line = null; $event = null; flush(); gc_collect_cycles(); var_dump(number_format(memory_get_usage(true))); $line = fgets($fp, 4096 * 1024); var_dump(number_format(memory_get_usage())); array_push($arr, $line); if(feof($fp))rewind($fp); } 通过后台命令行执行这个，会发现，memory_get_usage(true)会隔一段时间上升4M左右（没算，目测可能正好就是4M），而memory_get_usage()一直不大，一会就Allowed memory size of 16777216 bytes exhausted了 最终显示： 。。。。 。。。。 。。。。 string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,968,844&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,968,988&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,969,132&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,969,276&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,969,364&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,969,436&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,969,580&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,969,724&rdquo; string(10) &ldquo;13,893,632&rdquo; Fatal error: Allowed memory size of 16777216 bytes exhausted (tried to allocate 4194305 bytes) in /home/eChance/eChance/net_manager." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/blog/php-foreach-push/" />
<meta property="article:published_time" content="2013-02-01T20:58:36+08:00" />
<meta property="article:modified_time" content="2013-02-01T20:58:36+08:00" />

        <meta property="og:image" content="//images/logo.png">
        <meta property="og:image:type" content="image/png">
        <meta property="og:image:width" content="512">
        <meta property="og:image:height" content="512">
        <meta itemprop="name" content="关于循环fread后push数组，造成内存异常大并越界问题的思考">
<meta itemprop="description" content="原问题：
php版本5.3.6，线程安全版本，debian平台，php的memory_limit是16M event.txt文件只要有行就行，每行最好长一点，比较好重现，比如： 11111111111111111111111111111111111111111111 22222222222222222222222222222222222222222222 脚本：
$fp = fopen(&quot;event.txt&quot;, &quot;r&quot;); if(!$fp)exit(1); $arr = array(); while(true){ $line = null; $event = null; flush(); gc_collect_cycles(); var_dump(number_format(memory_get_usage(true))); $line = fgets($fp, 4096 * 1024); var_dump(number_format(memory_get_usage())); array_push($arr, $line); if(feof($fp))rewind($fp); } 通过后台命令行执行这个，会发现，memory_get_usage(true)会隔一段时间上升4M左右（没算，目测可能正好就是4M），而memory_get_usage()一直不大，一会就Allowed memory size of 16777216 bytes exhausted了 最终显示： 。。。。 。。。。 。。。。 string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,968,844&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,968,988&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,969,132&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,969,276&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,969,364&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,969,436&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,969,580&rdquo; string(10) &ldquo;13,893,632&rdquo; string(9) &ldquo;1,969,724&rdquo; string(10) &ldquo;13,893,632&rdquo; Fatal error: Allowed memory size of 16777216 bytes exhausted (tried to allocate 4194305 bytes) in /home/eChance/eChance/net_manager.">
<meta itemprop="datePublished" content="2013-02-01T20:58:36&#43;08:00" />
<meta itemprop="dateModified" content="2013-02-01T20:58:36&#43;08:00" />
<meta itemprop="wordCount" content="159">



<meta itemprop="keywords" content="" />
        

        
            
        

        
        
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">
            <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,800,900|Source+Sans+Pro:400,700">
            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.css">
            <link rel="stylesheet" href="/css/main.css">
            <link rel="stylesheet" href="/css/add-on.css">
            <link rel="stylesheet" href="/css/academicons.min.css">
        

        
            
                
            
        


  
    
    <link href='//cdn.bootcss.com/highlight.js/9.11.0/styles/github.min.css' rel='stylesheet' type='text/css' />
  


      
    </head>
    <body>

      
      <div id="wrapper">

    
    
<header id="header">
    
      <h1><a href="/">blog</a></h1>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="/">
                            <i class="fa fa-home">&nbsp;</i>Home
                    </a>
                </li>
            
                <li>
                    <a href="/about/">
                            <i class="fa fa-id-card-o">&nbsp;</i>About
                    </a>
                </li>
            
                <li>
                    <a href="/blog/">
                            <i class="fa fa-newspaper-o">&nbsp;</i>Blog
                    </a>
                </li>
            
                <li>
                    <a href="/itemized/">
                            <i class="fa fa-list">&nbsp;</i>Itemized
                    </a>
                </li>
            
                <li>
                    <a href="/categories/">
                            <i class="fa fa-sitemap">&nbsp;</i>Categories
                    </a>
                </li>
            
                <li>
                    <a href="/contact/">
                            <i class="fa fa-envelope-o">&nbsp;</i>Contact
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li id="share-nav" class="share-menu" style="display:none;">
                <a class="fa-share-alt" href="#share-menu">Share</a>
            </li>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="as_sitesearch" value="/">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="as_sitesearch" value="/">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="/">
                            <h3>
                                <i class="fa fa-home">&nbsp;</i>Home
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/about/">
                            <h3>
                                <i class="fa fa-id-card-o">&nbsp;</i>About
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/blog/">
                            <h3>
                                <i class="fa fa-newspaper-o">&nbsp;</i>Blog
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/itemized/">
                            <h3>
                                <i class="fa fa-list">&nbsp;</i>Itemized
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories/">
                            <h3>
                                <i class="fa fa-sitemap">&nbsp;</i>Categories
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/contact/">
                            <h3>
                                <i class="fa fa-envelope-o">&nbsp;</i>Contact
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section class="recent-posts">
            <div class="mini-posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                

                
                    
                

                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/blog/select-medium-number/">[转]在MySQL中，如何计算一组数据的中位数？</a></h3>
                                
                                <time class="published" datetime=
                                    '2021-01-07'>
                                    January 7, 2021</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/blog/redis-serializer/">jackson做redis反序列化时，反序列化Map&lt;Integer, T&gt;时的问题</a></h3>
                                
                                <time class="published" datetime=
                                    '2021-01-04'>
                                    January 4, 2021</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/blog/kafka-rebalance-protocol/">【译】【原】kafka rebalance 协议详解</a></h3>
                                
                                <time class="published" datetime=
                                    '2020-11-22'>
                                    November 22, 2020</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/blog/%E5%A2%9E%E5%8A%A0%E4%BF%A9php5-2-17%E7%9A%84gdbinit%E6%96%B9%E6%B3%95/">增加俩php5.2.17的.gdbinit方法</a></h3>
                                
                                <time class="published" datetime=
                                    '2018-10-31'>
                                    October 31, 2018</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/blog/redis-fluctruate/">redis可能波动的几种情况</a></h3>
                                
                                <time class="published" datetime=
                                    '2018-09-29'>
                                    September 29, 2018</time>
                            </header>
                            

                        </article>
                

                
                    <a href=
                        
                            /blog/
                        
                        class="button">View more posts</a>
                
            </div>
        </section>

    
        
</section>

    <section id="share-menu">
    <section id="social-share-nav">
        <ul class="links">
            <header>
                <h3>Share this post <i class="fa fa-smile-o"></i></h3>
            </header>
            



<li>
  <a href="//twitter.com/share?url=%2fblog%2fphp-foreach-push%2f&amp;text=%e5%85%b3%e4%ba%8e%e5%be%aa%e7%8e%affread%e5%90%8epush%e6%95%b0%e7%bb%84%ef%bc%8c%e9%80%a0%e6%88%90%e5%86%85%e5%ad%98%e5%bc%82%e5%b8%b8%e5%a4%a7%e5%b9%b6%e8%b6%8a%e7%95%8c%e9%97%ae%e9%a2%98%e7%9a%84%e6%80%9d%e8%80%83&amp;via=example" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
    </a>
</li>




<li>
  <a href="//plus.google.com/share?url=%2fblog%2fphp-foreach-push%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
  </a>
</li>





<li>
  <a href="//www.facebook.com/sharer/sharer.php?u=%2fblog%2fphp-foreach-push%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
    </a>
</li>




<li>
  <a href="//reddit.com/submit?url=%2fblog%2fphp-foreach-push%2f&amp;title=%e5%85%b3%e4%ba%8e%e5%be%aa%e7%8e%affread%e5%90%8epush%e6%95%b0%e7%bb%84%ef%bc%8c%e9%80%a0%e6%88%90%e5%86%85%e5%ad%98%e5%bc%82%e5%b8%b8%e5%a4%a7%e5%b9%b6%e8%b6%8a%e7%95%8c%e9%97%ae%e9%a2%98%e7%9a%84%e6%80%9d%e8%80%83" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
  </a>
</li>




<li>
  <a href="//www.linkedin.com/shareArticle?url=%2fblog%2fphp-foreach-push%2f&amp;title=%e5%85%b3%e4%ba%8e%e5%be%aa%e7%8e%affread%e5%90%8epush%e6%95%b0%e7%bb%84%ef%bc%8c%e9%80%a0%e6%88%90%e5%86%85%e5%ad%98%e5%bc%82%e5%b8%b8%e5%a4%a7%e5%b9%b6%e8%b6%8a%e7%95%8c%e9%97%ae%e9%a2%98%e7%9a%84%e6%80%9d%e8%80%83" target="_blank" class="share-btn linkedin">
      <i class="fa fa-linkedin"></i>
      <p>LinkedIn</p>
    </a>
</li>




<li>
  <a href="//www.stumbleupon.com/submit?url=%2fblog%2fphp-foreach-push%2f&amp;title=%e5%85%b3%e4%ba%8e%e5%be%aa%e7%8e%affread%e5%90%8epush%e6%95%b0%e7%bb%84%ef%bc%8c%e9%80%a0%e6%88%90%e5%86%85%e5%ad%98%e5%bc%82%e5%b8%b8%e5%a4%a7%e5%b9%b6%e8%b6%8a%e7%95%8c%e9%97%ae%e9%a2%98%e7%9a%84%e6%80%9d%e8%80%83" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
  </a>
</li>




<li>
  <a href="//www.pinterest.com/pin/create/button/?url=%2fblog%2fphp-foreach-push%2f&amp;description=%e5%85%b3%e4%ba%8e%e5%be%aa%e7%8e%affread%e5%90%8epush%e6%95%b0%e7%bb%84%ef%bc%8c%e9%80%a0%e6%88%90%e5%86%85%e5%ad%98%e5%bc%82%e5%b8%b8%e5%a4%a7%e5%b9%b6%e8%b6%8a%e7%95%8c%e9%97%ae%e9%a2%98%e7%9a%84%e6%80%9d%e8%80%83" target="_blank" class="share-btn pinterest">
    <i class="fa fa-pinterest-p"></i>
    <p>Pinterest</p>
  </a>
</li>




<li>
  <a href="mailto:?subject=Check out this post by &amp;body=%2fblog%2fphp-foreach-push%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
  </a>
</li>


        </ul>
    </section>
</section>

    
    <div id="main">
        
        
        <article class="post">
  <header>
    <div class="title">
        
            <h1><a href="/blog/php-foreach-push/">关于循环fread后push数组，造成内存异常大并越界问题的思考</a></h1>
            
        
        
    </div>
    <div class="meta">
        

        <time class="published"
            datetime='2013-02-01'>
            February 1, 2013</time>
        <span class="author"></span>
        
            <p>1 minute read</p>
        
        
    </div>
</header>


  
    <section id="social-share">
      <ul class="icons">
        



<li>
  <a href="//twitter.com/share?url=%2fblog%2fphp-foreach-push%2f&amp;text=%e5%85%b3%e4%ba%8e%e5%be%aa%e7%8e%affread%e5%90%8epush%e6%95%b0%e7%bb%84%ef%bc%8c%e9%80%a0%e6%88%90%e5%86%85%e5%ad%98%e5%bc%82%e5%b8%b8%e5%a4%a7%e5%b9%b6%e8%b6%8a%e7%95%8c%e9%97%ae%e9%a2%98%e7%9a%84%e6%80%9d%e8%80%83&amp;via=example" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
    </a>
</li>




<li>
  <a href="//plus.google.com/share?url=%2fblog%2fphp-foreach-push%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
  </a>
</li>





<li>
  <a href="//www.facebook.com/sharer/sharer.php?u=%2fblog%2fphp-foreach-push%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
    </a>
</li>




<li>
  <a href="//reddit.com/submit?url=%2fblog%2fphp-foreach-push%2f&amp;title=%e5%85%b3%e4%ba%8e%e5%be%aa%e7%8e%affread%e5%90%8epush%e6%95%b0%e7%bb%84%ef%bc%8c%e9%80%a0%e6%88%90%e5%86%85%e5%ad%98%e5%bc%82%e5%b8%b8%e5%a4%a7%e5%b9%b6%e8%b6%8a%e7%95%8c%e9%97%ae%e9%a2%98%e7%9a%84%e6%80%9d%e8%80%83" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
  </a>
</li>




<li>
  <a href="//www.linkedin.com/shareArticle?url=%2fblog%2fphp-foreach-push%2f&amp;title=%e5%85%b3%e4%ba%8e%e5%be%aa%e7%8e%affread%e5%90%8epush%e6%95%b0%e7%bb%84%ef%bc%8c%e9%80%a0%e6%88%90%e5%86%85%e5%ad%98%e5%bc%82%e5%b8%b8%e5%a4%a7%e5%b9%b6%e8%b6%8a%e7%95%8c%e9%97%ae%e9%a2%98%e7%9a%84%e6%80%9d%e8%80%83" target="_blank" class="share-btn linkedin">
      <i class="fa fa-linkedin"></i>
      <p>LinkedIn</p>
    </a>
</li>




<li>
  <a href="//www.stumbleupon.com/submit?url=%2fblog%2fphp-foreach-push%2f&amp;title=%e5%85%b3%e4%ba%8e%e5%be%aa%e7%8e%affread%e5%90%8epush%e6%95%b0%e7%bb%84%ef%bc%8c%e9%80%a0%e6%88%90%e5%86%85%e5%ad%98%e5%bc%82%e5%b8%b8%e5%a4%a7%e5%b9%b6%e8%b6%8a%e7%95%8c%e9%97%ae%e9%a2%98%e7%9a%84%e6%80%9d%e8%80%83" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
  </a>
</li>




<li>
  <a href="//www.pinterest.com/pin/create/button/?url=%2fblog%2fphp-foreach-push%2f&amp;description=%e5%85%b3%e4%ba%8e%e5%be%aa%e7%8e%affread%e5%90%8epush%e6%95%b0%e7%bb%84%ef%bc%8c%e9%80%a0%e6%88%90%e5%86%85%e5%ad%98%e5%bc%82%e5%b8%b8%e5%a4%a7%e5%b9%b6%e8%b6%8a%e7%95%8c%e9%97%ae%e9%a2%98%e7%9a%84%e6%80%9d%e8%80%83" target="_blank" class="share-btn pinterest">
    <i class="fa fa-pinterest-p"></i>
    <p>Pinterest</p>
  </a>
</li>




<li>
  <a href="mailto:?subject=Check out this post by &amp;body=%2fblog%2fphp-foreach-push%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
  </a>
</li>


      </ul>
    </section>
  

  

  <div id="content">
    <p><strong>原问题：</strong></p>
<p>php版本5.3.6，线程安全版本，debian平台，php的memory_limit是16M
event.txt文件只要有行就行，每行最好长一点，比较好重现，比如：
11111111111111111111111111111111111111111111
22222222222222222222222222222222222222222222
脚本：</p>
<pre><code>$fp = fopen(&quot;event.txt&quot;, &quot;r&quot;);
if(!$fp)exit(1);
$arr = array();
while(true){
$line = null;
$event = null;
flush();
gc_collect_cycles();
var_dump(number_format(memory_get_usage(true)));
$line = fgets($fp, 4096 * 1024);
var_dump(number_format(memory_get_usage()));
array_push($arr, $line);
if(feof($fp))rewind($fp);
}
</code></pre><p>通过后台命令行执行这个，会发现，memory_get_usage(true)会隔一段时间上升4M左右（没算，目测可能正好就是4M），而memory_get_usage()一直不大，一会就Allowed memory size of 16777216 bytes exhausted了
最终显示：
。。。。
。。。。
。。。。
string(10) &ldquo;13,893,632&rdquo;
string(9) &ldquo;1,968,844&rdquo;
string(10) &ldquo;13,893,632&rdquo;
string(9) &ldquo;1,968,988&rdquo;
string(10) &ldquo;13,893,632&rdquo;
string(9) &ldquo;1,969,132&rdquo;
string(10) &ldquo;13,893,632&rdquo;
string(9) &ldquo;1,969,276&rdquo;
string(10) &ldquo;13,893,632&rdquo;
string(9) &ldquo;1,969,364&rdquo;
string(10) &ldquo;13,893,632&rdquo;
string(9) &ldquo;1,969,436&rdquo;
string(10) &ldquo;13,893,632&rdquo;
string(9) &ldquo;1,969,580&rdquo;
string(10) &ldquo;13,893,632&rdquo;
string(9) &ldquo;1,969,724&rdquo;
string(10) &ldquo;13,893,632&rdquo;
Fatal error: Allowed memory size of 16777216 bytes exhausted (tried to allocate 4194305 bytes) in /home/eChance/eChance/net_manager.02.02.static/web/debug/test_loop_read_file.php on line 11
可见，最后一个fgets搞出了内存不够
问题如下：
文档说：memory_get_usage(true)显示的应该是实际分配的内存，memory_get_usage()应该是emalloc的内存，那他们俩的差值是怎么产生的内存，为什么没有释放？该怎么释放？emalloc的数据在这个例子中，分配的是$arr变量的内存吧？
memory_get_usage(true)也才13M多，可能是因为fgets后会再增加4M导致内存溢出，那就证明溢出的是fgets使用的一个内存区域，可我不理解他为什么一直增加不释放？
如果memory_get_usage(true)显示的是包括分配的缓存部分，memory_get_usage()是实际变量的话，那memory_get_usage()还远远不到memory_get_usage(true)的大小，也不应该重新申请啊</p>
<p><strong>想到的：</strong></p>
<p>1、假设memory_get_usage(true)-memory_get_usage()主要就是数组的管理内存。
2、每次memory_get_usage(true)增加和fgets请求的大小一致，或许是因为fgets确实需要分配内存，但使用后不释放，当做下一次fgets的缓存和数组的管理内存，直接使用，或许是避免每次都重新分配内存的一种优化方式吧。当这块内存被占满后，再进行下一次分配，所以之前的很多次提示memory_get_usage(true)已经是13.25M，但fgets时却没有提示，由于他也依然在用之前分配而未释放的这段内存区域。
3、即使$arr=null也不减小或许也是同理，虽然不减小，但也不会像之前一样继续增加内存分配，目的也是避免多次重新分配内存。
4、由于管理内存和fgets缓存都在用每次预分配的4M，可能会造成缓存和数组管理内存之间产生一定的内存碎片，间接造成memory_get_usage(true)过分的大。对于这种每次都彻底读出一个小文件全部内容的程序，应该用file函数可以得到很大优化</p>
<p><strong>验证：</strong></p>
<p>代码如下：</p>
<pre><code>$arr = array();
while(true){
$events = null;
flush();
gc_collect_cycles();
var_dump(number_format(memory_get_usage(true)));
$events = file(&quot;event.txt&quot;);
var_dump(number_format(memory_get_usage()));
$arr = array_merge($arr, $events);
}
</code></pre><p>执行效果如下：
。。。。
。。。。
。。。。
string(9) &ldquo;4,528,496&rdquo;
string(9) &ldquo;5,767,168&rdquo;
string(9) &ldquo;4,530,356&rdquo;
string(9) &ldquo;5,767,168&rdquo;
string(9) &ldquo;4,532,088&rdquo;
string(9) &ldquo;5,767,168&rdquo;
string(9) &ldquo;4,533,880&rdquo;
string(9) &ldquo;5,767,168&rdquo;
string(9) &ldquo;4,535,712&rdquo;
string(9) &ldquo;5,767,168&rdquo;
string(9) &ldquo;4,537,492&rdquo;
^C
最终我ctrl+c停止了，可以看到，memory_get_usage(true)与memory_get_usage()相差很小，确实有很大的优化效果，也验证了，管理内存绝对不会需要10倍多那么离谱。。。之前的memory_get_usage(true)超大很有可能是内存碎片造成。
暂时就当个想法吧，以后遇到这种问题先这么解决了<del>回头有时间研究一下内存管理器的源码验证一下</del>这个结论确实是瞎猜的算是，希望各位有啥新的想法随时来此赐教<del>谢谢</del></p>

  </div>

  <footer>
    <ul class="stats">
  <li class="categories">
    <ul>
        
            
            
                <i class="fa fa-folder"></i>
                
                
                <li><a class="article-category-link" href="/categories/php">php</a></li>
                
            
        
    </ul>
  </li>
  <li class="tags">
    <ul>
        
    </ul>
  </li>
</ul>

  </footer>

</article>

    <article class="post">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "shortname" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </article>


<ul class="actions pagination">
    
        <li><a href="/blog/mysql-trigger-error/"
                class="button big previous">mysql5.1.58 触发器中调用存储过程 出现“Table was not locked with LOCK TABLES”的解决办法</a></li>
    

    
        <li><a href="/blog/ext4-negtive-number-chart/"
                class="button big next">extjs4.1，能显示纵坐标中心为0点，可显示负数的area图表</a></li>
    
</ul>


    </div>
    
<section id="sidebar">

  
  <section id="intro">
    
    
      
        <a href='/' class="logo"><img src="/img/main/logo.jpg" alt="Hugo Future Imperfect" /></a>
      
    
    
      <header>
        <h2>yufulou的楼</h2>
        <p>try deep, try more</p>
      </header>
    
    
      <ul class="icons">
        
          
    <li><a href="/index.xml" type="application/rss+xml" target="_blank" title="RSS" class="fa fa-rss"></a></li>


        
        
  <li><a href="//github.com/jpescador/hugo-future-imperfect" target="_blank" title="GitHub" class="fa fa-github"></a></li>















  <li><a href="//flickr.com/photos/example" target="_blank" title="Flickr" class="fa fa-flickr"></a></li>











  <li><a href="//linkedin.com/in/example" target="_blank" title="LinkedIn" class="fa fa-linkedin"></a></li>



  <li><a href="//linkedin.com/company/examplebusiness" target="_blank" title="LinkedIn Company" class="fa fa-linkedin"></a></li>









  <li><a href="//facebook.com/example" target="_blank" title="Facebook" class="fa fa-facebook"></a></li>





  <li><a href="//reddit.com/user/example" target="_blank" title="Reddit" class="fa fa-reddit"></a></li>

















  <li><a href="//instagram.com/example" target="_blank" title="Instagram" class="fa fa-instagram"></a></li>





  <li><a href="//twitter.com/example" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>







  <li><a href="//pinterest.com/example" target="_blank" title="Pinterest" class="fa fa-pinterest-p"></a></li>



  <li><a href="//telegram.me/example" target="_blank" title="telegram" class="fa fa-telegram"></a></li>









<li><a href="//researchgate.net/profile/example" target="_blank" title="Research Gate"><i class="ai ai-researchgate"></i></a></li>



  <li><a href="mailto:example" title="Email" class="fa fa-envelope"></a></li>


      </ul>
    
  </section>

  
  <section class="recent-posts">
    <div class="mini-posts">
      <header>
        <h3>Recent Posts</h3>
      </header>
      <div class="posts-container">
        

        
          
        

        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/blog/select-medium-number/">[转]在MySQL中，如何计算一组数据的中位数？</a>
              </h3>
              
              <time class="published" datetime='2021-01-07'>
                January 7, 2021
              </time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/blog/redis-serializer/">jackson做redis反序列化时，反序列化Map&lt;Integer, T&gt;时的问题</a>
              </h3>
              
              <time class="published" datetime='2021-01-04'>
                January 4, 2021
              </time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/blog/kafka-rebalance-protocol/">【译】【原】kafka rebalance 协议详解</a>
              </h3>
              
              <time class="published" datetime='2020-11-22'>
                November 22, 2020
              </time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/blog/%E5%A2%9E%E5%8A%A0%E4%BF%A9php5-2-17%E7%9A%84gdbinit%E6%96%B9%E6%B3%95/">增加俩php5.2.17的.gdbinit方法</a>
              </h3>
              
              <time class="published" datetime='2018-10-31'>
                October 31, 2018
              </time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <h3>
                <a href="/blog/redis-fluctruate/">redis可能波动的几种情况</a>
              </h3>
              
              <time class="published" datetime='2018-09-29'>
                September 29, 2018
              </time>
            </header>
            

          </article>
        
      </div>

      
        <a href=
          
            /blog/
          
        class="button">View more posts</a>
      
    </div>
  </section>

  
  
  
  
  
    <section id="categories">
      <header>
        <h3>
          <a href="/categories/">Categories</a>
        </h3>
      </header>
        
          
        

        
        <p>
          <article>
            <header>
              
                <a href="/categories/php/">php</a>
                <span style="float:right;">7</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/mysql/">mysql</a>
                <span style="float:right;">5</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                Uncategorized
                <span style="float:right;">4</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/linux/">linux</a>
                <span style="float:right;">4</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/js/">js</a>
                <span style="float:right;">3</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/apache/">apache</a>
                <span style="float:right;">1</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/jackson/">jackson</a>
                <span style="float:right;">1</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/java/">java</a>
                <span style="float:right;">1</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/kafka/">kafka</a>
                <span style="float:right;">1</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/lvs/">lvs</a>
                <span style="float:right;">1</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/mongo/">mongo</a>
                <span style="float:right;">1</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/op/">op</a>
                <span style="float:right;">1</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/redis/">redis</a>
                <span style="float:right;">1</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/serialize/">serialize</a>
                <span style="float:right;">1</span>
              
            </header>
          </article>
        </p>
        
        <p>
          <article>
            <header>
              
                <a href="/categories/sql/">sql</a>
                <span style="float:right;">1</span>
              
            </header>
          </article>
        </p>
        
    </section>
  
  

  
  
    <section id="mini-bio">
      <h3>About</h3>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Praesent tellus lacus, auctor vehicula molestie quis, tempor quis velit. Quisque in quam ac leo efficitur vulputate. Phasellus ullamcorper aliquam sodales. Maecenas sit amet condimentum ipsum. Proin sit amet ligula elit. Mauris.</p>
      <a href="/about/" class="button">Learn More</a>
    </section>
  

  
  <section id="footer">
    
      <ul class="icons">
        
          
    <li><a href="/index.xml" type="application/rss+xml" target="_blank" title="RSS" class="fa fa-rss"></a></li>


        
        
  <li><a href="//github.com/jpescador/hugo-future-imperfect" target="_blank" title="GitHub" class="fa fa-github"></a></li>















  <li><a href="//flickr.com/photos/example" target="_blank" title="Flickr" class="fa fa-flickr"></a></li>











  <li><a href="//linkedin.com/in/example" target="_blank" title="LinkedIn" class="fa fa-linkedin"></a></li>



  <li><a href="//linkedin.com/company/examplebusiness" target="_blank" title="LinkedIn Company" class="fa fa-linkedin"></a></li>









  <li><a href="//facebook.com/example" target="_blank" title="Facebook" class="fa fa-facebook"></a></li>





  <li><a href="//reddit.com/user/example" target="_blank" title="Reddit" class="fa fa-reddit"></a></li>

















  <li><a href="//instagram.com/example" target="_blank" title="Instagram" class="fa fa-instagram"></a></li>





  <li><a href="//twitter.com/example" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>







  <li><a href="//pinterest.com/example" target="_blank" title="Pinterest" class="fa fa-pinterest-p"></a></li>



  <li><a href="//telegram.me/example" target="_blank" title="telegram" class="fa fa-telegram"></a></li>









<li><a href="//researchgate.net/profile/example" target="_blank" title="Research Gate"><i class="ai ai-researchgate"></i></a></li>



  <li><a href="mailto:example" title="Email" class="fa fa-envelope"></a></li>


      </ul>
    
    <p class="copyright">
      
        &copy; 2021
        
          yufulou&#39;s 
        
      .
      Powered by <a href="//gohugo.io" target="_blank">Hugo</a>
    </p>
  </section>
</section>

    </div>
    <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
    

    
      
    

    
      
      
      
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/highlight.min.js"></script>
        
        
        
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/r.min.js"></script>
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/yaml.min.js"></script>
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/css.min.js"></script>
        <script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>
      
    
    
    
      <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/skel/3.0.1/skel.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.js"></script>
      <script src="/js/util.js"></script>
      <script src="/js/main.js"></script>
      <script src="/js/backToTop.js"></script>
    

    
      
        
      
    

    
    <script>hljs.initHighlightingOnLoad();</script>
      <script src="//yihui.name/js/math-code.js"></script>
<script async
src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


  </body>
</html>

